#
# StartOS package build script
#
# Copyright 2012 StartOS
# Distributed under the terms of the GNU General Public License v2
#

DESCRIPTION="A sophisticated object-relational DBMS"
HOMEPAGE="http://www.postgresql.org/"
LICENSE="custom:PostgreSQL"
PACKAGER="Zhongxin Huang <huangzhongxin@ivali.com>"

SRC_URI="ftp://ftp.postgresql.org/pub/source/v"$V"/"$N-$V".tar.bz2"
CHECKSUM="1cc388988e69bf75c6b55d59070100f6"

PROVIDE="postgresql postgresql-libs postgresql-docs"

BDEPEND="krb5 libxml2 python perl tcl openssl"

pbs_unpack() {
    dounpack
}

pbs_patch() {
    dopatch postgresql-run-socket.patch
}

pbs_config() {
    config+="--datadir=/usr/share/postgresql 
             --with-krb5 
             --with-libxml 
             --with-openssl 
             --with-perl 
             --with-tcl 
             --with-pam 
             --with-system-tzdata=/usr/share/zoneinfo 
             --enable-nls 
             --enable-thread-safety"
    doconfig
}

pbs_build() {
    domake world
}

postgresql_install() {
    DESCRIPTION="A sophisticated object-relational DBMS"
    RDEPEND="postgresql-libs krb5 libxml2 readline openssl"
    
    INSTALL="$N".install

    cd "$srcdir"

    # install
    domkinstall
    make -C contrib DESTDIR="$destdir" install
    make -C doc/src/sgml DESTDIR="$destdir" install-man

    # we don't want these, they are in the -libs package
    for dir in src/interfaces src/bin/pg_config src/bin/psql; do
        make -C "${dir}" DESTDIR="$destdir" uninstall
    done
    
    # install license
    dodoc COPYRIGHT

    # clean up unneeded installed items
    cd "$destdir"
    rm -rf usr/include/postgresql/internal usr/include/libpq usr/share/doc/postgresql/html
    find "usr/include" -maxdepth 1 -type f -execdir rm {} +

    # install launch script
    docp "$filesdir"/postgresql.conf usr/lib/tmpfiles.d/
    dounit postgresql.service
    docp "$filesdir"/postgresql-check-db-dir usr/bin/
    dopamd postgresql
    docp_rename "$filesdir"/postgresql.logrotate etc/logrotate.d/postgresql
}

postgresql-libs_install() { 
    DESCRIPTION="libraries and client of PostgreSQL"
    RDEPEND="openssl readline krb5"
    
    cd "$srcdir"

    # install license
    dodoc COPYRIGHT

    # install libs
    for dir in src/interfaces src/bin/pg_config src/bin/psql; do
        domkinstall -C "${dir}"
    done

    doman doc/src/sgml/man1/pg_config.1
    doman doc/src/sgml/man1/psql.1

    cd src/include

    # these headers are needed by the public headers of the interfaces
    docp pg_config.h pg_config_os.h postgres_ext.h pg_config_manual.h "${destdir}"/usr/include/
    docp libpq/libpq-fs.h                                             "${destdir}"/usr/include/libpq/

    # these headers are needed by the not-so-public headers of the interfaces
    docp c.h port.h postgres_fe.h  "$destdir"/usr/include/postgresql/internal/
    docp libpq/pqcomm.h            "$destdir"/usr/include/postgresql/internal/libpq/
}

postgresql-docs_install() {
    DESCRIPTION="HTML documentation for PostgreSQL"
     
    cd "$srcdir" 
    make -C doc/src/sgml DESTDIR="$destdir" install-html
    chown -R root:root "$destdir"/usr/share/doc/postgresql/html/
    dodoc COPYRIGHT
    # clean up
    rmdir "$destdir"/usr/share/man/man{1,3,7}
    rmdir "$destdir"/usr/share/man
}

