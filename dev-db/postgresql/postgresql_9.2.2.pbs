#
# StartOS package build script
#
# Copyright 2012 StartOS
# Distributed under the terms of the GNU General Public License v2
#

DESCRIPTION="A sophisticated object-relational DBMS"
HOMEPAGE="http://www.postgresql.org/"
LICENSE="custom:PostgreSQL"
PACKAGER="Zhongxin Huang <huangzhongxin@ivali.com>"

SRC_URI="ftp://ftp.postgresql.org/pub/source/v"$V"/"$N-$V".tar.bz2"
CHECKSUM="1cc388988e69bf75c6b55d59070100f6"

RDEPEND="postgresql-libs krb5 libxml2 readline openssl"
BDEPEND="python perl tcl"

INSTALL="$N".install

pbs_unpack() {
    dounpack
}

pbs_patch() {
    dopatch postgresql-run-socket.patch
}

pbs_config() {
    config+="--datadir=/usr/share/postgresql 
             --with-krb5 
             --with-libxml 
             --with-openssl 
             --with-perl 
             --with-tcl 
             --with-pam 
             --with-system-tzdata=/usr/share/zoneinfo 
             --enable-nls 
             --enable-thread-safety"
    doconfig
}

pbs_build() {
    domake world
}

pbs_install() {
    domkinstall
    make -C contrib DESTDIR="$destdir" install
    make -C doc/src/sgml DESTDIR="$destdir" install-man
    # We don't want these, they are in the -libs package
    for dir in src/interfaces src/bin/pg_config src/bin/psql; do
        make -C "${dir}" DESTDIR="$destdir" uninstall
    done
    rm "$destdir"/usr/share/man/man1/{psql.1,pg_config.1}
    # Install license
    dodoc COPYRIGHT
    # clean up unneeded installed items
    cd "$destdir"
    rm -rf usr/include/postgresql/internal usr/include/libpq usr/share/doc/postgresql/html
    find "usr/include" -maxdepth 1 -type f -execdir rm {} +
    # Install launch script
    docp "$filesdir"/postgresql.conf usr/lib/tmpfiles.d/
    dounit postgresql.service
    docp "$filesdir"/postgresql-check-db-dir usr/bin/
    dopamd postgresql
    docp_rename "$filesdir"/postgresql.logrotate etc/logrotate.d/postgresql
}

