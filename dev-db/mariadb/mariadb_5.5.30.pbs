#
# StartOS package build script
#
# Copyright 2012 StartOS
# Distributed under the terms of the GNU General Public License v2
#

DESCRIPTION="Fast SQL database server, drop-in replacement for MySQL"
HOMEPAGE="http://mariadb.org/"
LICENSE="GPL"
PACKAGER="Zhongxin Huang <huangzhongxin@ivali.com>"

SRC_URI="http://mirrors.supportex.net/$N/$N-$V/kvm-tarbake-jaunty-x86/$N-$V.tar.gz"
CHECKSUM="64dba5f1819f1d4ebf7ed31d74e4106c981a24b88259995deba3734fb7c4635f"

RDEPEND="mariadb-clients systemd openssl gcc-libs ncurses pam"
BDEPEND="cmake openssl zlib"
REPLACE="mysql"

INSTALL="$N.install"

pbs_unpack() {
    dounpack
}

pbs_config() {
    mkdir build
    cd build
    # CFLAGS/CXXFLAGS as suggested upstream
    cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr \
          -DSYSCONFDIR=/etc/mysql \
          -DMYSQL_DATADIR=/var/lib/mysql \
          -DMYSQL_UNIX_ADDR=/run/mysqld/mysqld.sock \
          -DDEFAULT_CHARSET=utf8 \
          -DDEFAULT_COLLATION=utf8_general_ci \
          -DENABLED_LOCAL_INFILE=ON \
          -DINSTALL_INFODIR=share/mysql/docs \
          -DINSTALL_MANDIR=share/man \
          -DINSTALL_LIBDIR=lib"$LIBDIRSUFFIX" \
          -DINSTALL_PLUGINDIR=lib"$LIBDIRSUFFIX"/mysql/plugin \
          -DINSTALL_SCRIPTDIR=bin \
          -DINSTALL_INCLUDEDIR=include/mysql \
          -DINSTALL_DOCREADMEDIR=share/mysql \
          -DINSTALL_SUPPORTFILESDIR=share/mysql \
          -DINSTALL_MYSQLSHAREDIR=share/mysql \
          -DINSTALL_DOCDIR=share/mysql/docs \
          -DINSTALL_SHAREDIR=share/mysql \
          -DWITH_READLINE=ON \
          -DWITH_ZLIB=system \
          -DWITH_SSL=system \
          -DWITH_LIBWRAP=OFF \
          -DWITH_EXTRA_CHARSETS=complex \
          -DWITH_EMBEDDED_SERVER=ON \
          -DWITH_INNOBASE_STORAGE_ENGINE=1 \
          -DWITH_PARTITION_STORAGE_ENGINE=1 \
          -DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 \
          -DWITHOUT_ARCHIVE_STORAGE_ENGINE=1 \
          -DWITHOUT_BLACKHOLE_STORAGE_ENGINE=1 \
          -DWITHOUT_FEDERATED_STORAGE_ENGINE=1 \
          -DCMAKE_C_FLAGS="-fPIC ${CFLAGS} -fno-strict-aliasing -DBIG_JOINS=1 -fomit-frame-pointer" \
          -DCMAKE_CXX_FLAGS="-fPIC ${CXXFLAGS} -fno-strict-aliasing -DBIG_JOINS=1 -felide-constructors -fno-rtti"
}

pbs_build() {
    domake
}

pbs_install() {
    domkinstall
    
    cd "$PKGDIR"
    
    docp_rename usr/share/mysql/my-medium.cnf    etc/mysql/my.cnf
    docp_rename "$FILESDIR"/mariadb-post         usr/bin/mysqld-post
    docp_rename "$FILESDIR"/mariadb.service      usr/lib/systemd/system/mysqld.service
    docp_rename "$FILESDIR"/mariadb-tmpfile.conf usr/lib/tmpfiles.d/mysqld.conf

    # Provided by libmariadbclient package
    rm usr/bin/{mysql_config,mysql_client_test_embedded,mysqltest_embedded}
    rm usr/lib"$LIBDIRSUFFIX"/libmysql*
    rm -r usr/include/
    rm usr/share/man/man1/{mysql_config,mysql_client_test_embedded,mysqltest_embedded}.1

    # Provided by mariadb-clients package
    rm usr/bin/{mysql,mysqladmin,mysqlcheck,mysqldump,mysqlimport,mysqlshow,mysqlslap} 
    rm usr/share/man/man1/{mysql,mysqladmin,mysqlcheck,mysqldump,mysqlimport,mysqlshow,mysqlslap}.1

    # Not needed
    rm -r usr/{data,mysql-test,sql-bench}
    rm usr/share/man/man1/mysql-test-run.pl.1
}
