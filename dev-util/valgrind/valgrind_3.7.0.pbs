#
# StartOS package build script
#
# Copyright 2012 StartOS
# Distributed under the terms of the GNU General Public License v2
#

DESCRIPTION="An open-source memory debugger for GNU/Linux"
HOMEPAGE="http://www.valgrind.org"
LICENSE="GPL"
PACKAGER="StartOS Developers"

SRC_URI="http://www.valgrind.org/downloads/"$N-$V".tar.bz2"

RDEPEND="glibc"
BDEPEND=""
RECOMMENDED=""

NOTES="Valgrind will not work if glibc does not have debug symbols."

pbs_unpack() {
        dounpack
}

pbs_patch() {
	# Don't force multiarch stuff on OSX, bug #306467
	sed -i -e 's:-arch \(i386\|x86_64\)::g' Makefile.all.am

	# Respect CFLAGS, LDFLAGS
	dopatch valgrind-3.7.0-respect-flags.patch

	# Changing Makefile.all.am to disable SSP
	dopatch valgrind-3.7.0-fno-stack-protector.patch

	# Yet more local labels, this time for ppc32 & ppc64
	dopatch valgrind-3.6.0-local-labels.patch

	# Don't build in empty assembly files for other platforms or we'll get a QA
	# warning about executable stacks.
	dopatch valgrind-3.7.0-non-exec-stack-v2.patch

	# Fix the regex to get gcc's version
	dopatch valgrind-3.7.0-fix-gcc-regex.patch

	# Fix stricter use of dir variables, bug #397429
	dopatch valgrind-3.7.0-automake-1.11.2.patch

	# Fix for glibc 2.15, bug #398921
	dopatch valgrind-3.7.0-glibc-2.15.patch
}

pbs_config() {
	case "${ARCH}" in 
		x86_64) config+="--enable-only64bit" ;;
		 i686)  config+="--enable-only32bit"
	esac
	config+="--without-mpicc"
	doconfig
}

pbs_build() {
	domake
}

pbs_install() {
	domkinstall
}

