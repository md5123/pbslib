#
# Ylmf OS package build script
#

DESCRIPTION="Larry Wall's Practical Extraction and Report Language"
HOMEPAGE="http://www.perl.org/"
LICENSE="GPL, PerlArtistic"
PACKAGER="Ylmf OS Developers <ylmfos@ylmf.com>"

SRC_URI="http://www.cpan.org/src/5.0/"$N-$V".tar.bz2"
CHECKSUM="e7457deea78330c5f8eebb2fd2a45479"

RDEPEND="berkeley-db gdbm glibc zlib"
BDEPEND=""

pbs_unpack() {
        dounpack
}

pbs_config() {
	if [ "$ARCH" = "x86_64" ]; then
	        ylmfos_opts="-Dcccdlflags='-fPIC'"
	else 
		ylmfos_opts=""
	fi

	# Builds the Compress::Raw::Zlib module. 
	# By default Perl will use an internal copy of the Zlib source 
	# for the build. Issue the following command so that Perl 
	# will use the Zlib library installed on the system: 
	sed -i -e '/^BUILD_ZLIB/s/True/False/' \
	       -e '/^INCLUDE/s,\./zlib-src,/usr/include,' \
       	       -e '/^LIB/s,\./zlib-src,/usr/lib'"$LIBDIRSUFFIX"',' \
       	       cpan/Compress-Raw-Zlib/config.in	
	
	# There is a further (possibly cosmetic) anomaly - if we install perl and then run perl -V it will claim that libc is in /lib.
	sed -i "/libc/s@/lib@/lib'"$LIBDIRSUFFIX"'@" hints/linux.sh

	# We still need to tell perl to actually use lib64:
	echo installstyle=\"lib"$LIBDIRSUFFIX"/perl5\" >>hints/linux.sh

	./Configure -des -Dusethreads -Duseshrplib -Doptimize="${CFLAGS}" \
	            -Dprefix=/usr -Dvendorprefix=/usr \
	            -Dprivlib=/usr/share/perl5/core_perl \
		    -Darchlib=/usr/lib"$LIBDIRSUFFIX"/perl5/core_perl \
		    -Dsitelib=/usr/share/perl5/site_perl \
		    -Dsitearch=/usr/lib"$LIBDIRSUFFIX"/perl5/site_perl \
		    -Dvendorlib=/usr/share/perl5/vendor_perl \
		    -Dvendorarch=/usr/lib"$LIBDIRSUFFIX"/perl5/vendor_perl \
		    -Dinc_version_list=none \
		    -Dman1ext=1perl -Dman3ext=3perl "$ylmfos_opts" \
		    -Dlddlflags="-shared ${LDFLAGS}" -Dldflags="${LDFLAGS}" \
		    -Dman1dir=/usr/share/man/man1 \
		    -Dman3dir=/usr/share/man/man3 \
		    -Dpager="/bin/less -isR" \
		    -Dcc="gcc-lib ${BUILD}"  \
		    -Dusethreads -Duseshrplib
		    #-Dscriptdir=/usr/bin/core_perl \
		    #-Dsitescript=/usr/bin/site_perl \
		    #-Dvendorscript=/usr/bin/vendor_perl \
}

pbs_build() {
	domake
}

pbs_install() {
	domkinstall
	
	cd "$destdir"
	
	### CPAN Settings ###
	# Set CPAN default config to use the site directories.
	sed -e '/(makepl_arg =>/   s/""/"INSTALLDIRS=site"/' \
	    -e '/(mbuildpl_arg =>/ s/""/"installdirs=site"/' \
	    -i usr/share/perl5/core_perl/CPAN/FirstTime.pm

	### CPANPLUS Settings ###
	# Set CPANPLUS default config to use the site directories.
	sed -e "/{'makemakerflags'}/ s/'';/'INSTALLDIRS=site';/" \
	    -e "/{'buildflags'}/     s/'';/'installdirs=site';/" \
	    -i usr/share/perl5/core_perl/CPANPLUS/Config.pm

	# Profile script to set paths to perl scripts.
	docp $filesdir/{perlbin.sh,perlbin.csh} etc/profile.d/

	#
        mv usr/bin/perl"$V" usr/bin/perl
	doln /usr/bin/c2ph usr/bin/pstruct
	doln /usr/bin/s2p  usr/bin/psed

	# Remove all pod files *except* those under /usr/share/perl5/core_perl/pod/
	rm -f usr/share/perl5/core_perl/*.pod
	for d in usr/share/perl5/core_perl/*; do
		if [ -d $d ] && [ $(basename $d) != "pod" ]; then
		        find $d -name *.pod -delete
		fi
        done
        find usr/lib -name *.pod -delete
        find . -name .packlist -delete
	
	# Add /usr/lib/perl5/core_perl/CORE/ to standard library path 
	install -d etc/ld.so.conf.d
	echo "/usr/lib/perl5/core_perl/CORE" >etc/ld.so.conf.d/perl.conf

	#case $ARCH in 
	#	i?86) 	mv usr/bin/perl{,-32}
	#		mv usr/bin/perl5.14.0{,-32} ;;
	#      x86_64)	mv usr/bin/perl{,-64}
	#		mv usr/bin/perl5.14.0{,-64}
	#		doln /usr/bin/multiarch_wrapper usr/bin/perl
	#		doln /usr/bin/multiarch_wrapper usr/bin/perl5.14.0
	#esac
}


