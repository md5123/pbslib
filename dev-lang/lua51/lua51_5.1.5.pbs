#
# StartOS package build script
#
# Copyright 2012 StartOS
# Distributed under the terms of the GNU General Public License v2
#

DESCRIPTION="A powerful light-weight programming language designed for extending applications(version 5.1.x)"
HOMEPAGE="http://www.lua.org"
LICENSE="MIT"
PACKAGER="Zhongxin Huang <huangzhongxin@ivali.com>"
 
SRC_URI="http://www.lua.org/ftp/lua-"$V".tar.gz"
CHECKSUM="2e115fe26e435e33b0d5c022e4490567"

RDEPEND="readline"
BDEPEND=""

pbs_unpack() {
    dounpack
}

pbs_patch () {
    dopatch lua-arch.patch lua-5.1-cflags.diff
}

pbs_build() {
	[ "$ARCH" == "x86_64" ] && export CFLAGS="$CFLAGS -fPIC"
    sed -e 's:llua:llua5.1:' -e 's:/include:/include/lua5.1:' -i etc/lua.pc
    sed -r -e '/^LUA_(SO|A|T)=/ s/lua/lua5.1/' -e '/^LUAC_T=/ s/luac/luac5.1/' -i src/Makefile
    domake MYCFLAGS=\"$CFLAGS\" MYLDFLAGS=\"$LDFLAGS\" linux
}

pbs_install() {
    make TO_BIN="lua5.1 luac5.1" \
         TO_LIB="liblua5.1.a liblua5.1.so liblua5.1.so.5.1 liblua5.1.so.$V" \
         INSTALL_DATA='cp -d' \
         INSTALL_TOP="$destdir"/usr \
         INSTALL_INC="$destdir"/usr/include/lua5.1 \
         INSTALL_LIB="$destdir"/usr/lib"$LIBDIRSUFFIX" \
         INSTALL_MAN="$destdir"/usr/share/man/man1 \
    install
                
    dodoc doc/*.{gif,png,css,html} COPYRIGHT
    sed -i 's/\/lib/\/lib'"$LIBDIRSUFFIX"'/g' etc/lua.pc
    install -D -m644 etc/lua.pc "$destdir"/usr/lib"$LIBDIRSUFFIX"/pkgconfig/lua5.1.pc
    cd "$destdir"
    rmdir -p usr/lib/lua/"${V%.?}" 2>/dev/null
    cd usr/lib"$LIBDIRSUFFIX"
    ln -s liblua5.1.so liblua.so.5.1
    ln -s liblua5.1.so liblua.so."$V"
    cd "$destdir"/usr/share/man/man1
    mv lua.1 lua5.1.1
    mv luac.1 luac5.1.1
}
