#
# StartOS package build script
#
# Copyright 2012 StartOS
# Distributed under the terms of the GNU General Public License v2
#

DESCRIPTION="Mozilla's Network Security Services library that implements PKI support"
HOMEPAGE="http://www.mozilla.org/projects/security/pki/nss/"
LICENSE="GPL-2"

SRC_URI="http://ftp.mozilla.org/pub/mozilla.org/security/"$N"/releases/NSS_3_12_6_RTM/src/"$N-$V".tar.gz"

RDEPEND="glibc nspr sqlite zlib"
BDEPEND="   "

pbs_unpack() {
        dounpack
}

pbs_build() {
	export BUILD_OPT=1 
	export NSS_USE_SYSTEM_SQLITE=1 
	export NSPR_INCLUDE_DIR=/usr/include/nspr 
	export USE_SYSTEM_ZLIB=1 
	export ZLIB_LIBS=-lz 
	dopatch "$N-$V"-standalone-1.patch 
	make -C mozilla/security/nss nss_build_all
}

pbs_install() {
	NSS_LINUXDIR="Linux2.6_x86_glibc_PTH_OPT.OBJ"
	cd mozilla/dist 
	for i in $(ls "$NSS_LINUXDIR"/lib/*.so); do
		docp $(readlink -f "$i") "$destdir"/usr/lib 
	done
	for i in $(ls "$NSS_LINUXDIR"/lib/{*.chk,libcrmf.a}); do
		docp $(readlink -f "$i") "$destdir"/usr/lib 
	done
	for i in $(ls "$NSS_LINUXDIR"/bin/{certutil,nss-config,pk12util}); do
		docp $(readlink -f "$i") "$destdir"/usr/bin 
	done
	for i in $(ls {public,private}/nss/*); do
		docp $(readlink -f "$i") "$destdir"/usr/include/nss
	done
	docp "$(readlink -f "$NSS_LINUXDIR"/lib/pkgconfig/nss.pc)" "$destdir"/usr/lib/pkgconfig 	#
	cd "$destdir"/
	doln /usr/lib/libnss3.so      usr/lib/libnss3.so.1d
	doln /usr/lib/libnssutil3.so  usr/lib/libnssutil3.so.1d
	doln /usr/lib/libsmime3.so    usr/lib/libsmime3.so.1d
}
