#
# StartOS package build script
#
# Copyright 2012 StartOS
# Distributed under the terms of the GNU General Public License v2
#

DESCRIPTION="Advanced version control system"
HOMEPAGE="http://subversion.apache.org/"
LICENSE="APACHE"
PACKAGER="Zhongxin Huang <huangzhongxin@ivali.com>"

SRC_URI="http://mirror.bjtu.edu.cn/apache/"$N"/"$N-$V".tar.bz2"

RDEPEND="apr-util file neon sqlite"
BDEPEND="apache apache-dev"
RECOMMENDED="bash-completion libgnome-keyring"
OPTIONAL="bash-completion: for svn bash completion
          java-environment (openjdk6, jdk7-openjdk):
          kdeutils-kwallet:
          libgnome-keyring:
          python: for some hook scripts"

pbs_unpack() {
    dounpack
}

pbs_patch() {
    dopatch subversion.rpath.fix.patch subversion-1.7.6-kwallet-gcc47.patch
}

pbs_config() {
	config+="--with-apr=/usr 
             --with-apr-util=/usr 
             --with-zlib=/usr 
             --with-neon=/usr 
             --with-apxs 
             --with-sqlite=/usr 
             --with-gnome-keyring"
             #--with-berkeley-db=:/usr/include/:/usr/lib:db-5.3 
             #--enable-javahl --with-kwallet
	doconfig
}

pbs_build() {
	domake 
}

pbs_install() {
	domkinstall INSTALLDIRS=vendor
    docp tools/hook-scripts "$destdir"/usr/share/subversion/
    docp_rename tools/client-side/bash_completion "$destdir"/usr/share/bash-completion/completions/subversion
    cd "$destdir"/
    rm usr/share/subversion/hook-scripts/*.in
    ## svnserve ...
    # iniscript/xinetd
    docp "$filesdir"/svn etc/xinetd.d/
    # systemd
    dounit svnserve.service
    docp "$filesdir"/svnserve.conf usr/lib/tmpfiles.d/
    # misc
    for i in svn svnadmin svndumpfilter svnlook svnsync svnversion; do
        ln -sf subversion usr/share/bash-completion/completions/"${i}"
    done
}

